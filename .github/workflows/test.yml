name: test
on:
  push:
env:
  MSYSTEM: UCRT64 # use the msys2 UCRT64 environment
  HOME: d:\myhome # use d:\myhome as msys2 home dir
jobs:
  build:
    name: "msyst test"
    runs-on: windows-latest
    defaults:
      run:
        shell: C:\msys64\usr\bin\bash.exe -l {0}
    steps:
      - name: "Init msys2 (and install procps needed for free command)"
        run: pacman --noconfirm -S procps
      - name: "Update msys2 part 1"
        # this may update msys2-runtime which closed also the current bash -> run in a cmd
        shell: cmd
        run: C:\msys64\usr\bin\pacman.exe --noconfirm -Syuu
      - name: "Update msys2 part 2"
        run: pacman --noconfirm -Syuu
      - name: "Install msys2 packages and cleanup"
        run: >
          pacman --noconfirm -S
          mingw-w64-ucrt-x86_64-cmake
      - name: "cmake"
        if: ${{always()}}
        run: cmake -h
      - name: "cmake"
        if: ${{always()}}
        run: ldd /ucrt64/bin/cmake.exe
      - name: "Downgrade openssl to 3.1.4-1"
        run: >
          mkdir openssl && cd openssl &&
          wget --no-verbose https://repo.msys2.org/mingw/ucrt64/mingw-w64-ucrt-x86_64-openssl-3.1.4-1-any.pkg.tar.zst &&
          pacman --noconfirm -U mingw-w64-ucrt-x86_64-openssl-3.1.4-1-any.pkg.tar.zst &&
          cd .. && rm -rf openssl
      - name: "Downgrade cmake"
        run: >
          mkdir cmake && cd cmake &&
          wget --no-verbose https://repo.msys2.org/mingw/ucrt64/mingw-w64-ucrt-x86_64-cmake-3.27.9-1-any.pkg.tar.zst &&
          pacman --noconfirm -U mingw-w64-ucrt-x86_64-*.pkg.tar.zst &&
          cd .. && rm -rf cmake
      - name: "cmake"
        if: ${{always()}}
        run: cmake -h
      - name: "cmake"
        if: ${{always()}}
        run: ldd /ucrt64/bin/cmake.exe
